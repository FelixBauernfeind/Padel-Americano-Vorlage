<script>
let playerNames = [];
let stats = {};
let scoreInputs = {};

/* ===== STORAGE ===== */
function saveState() {
  document.querySelectorAll(".score").forEach(inp => {
    if (inp.id) scoreInputs[inp.id] = inp.value;
  });

  localStorage.setItem("americanoState", JSON.stringify({
    count: count.value,
    playerNames,
    scoreInputs
  }));
}

function loadState() {
  const raw = localStorage.getItem("americanoState");
  if (!raw) return;

  const s = JSON.parse(raw);
  count.value = s.count || 8;
  playerNames = s.playerNames || [];
  scoreInputs = s.scoreInputs || {};
  renderPlayers();
}

/* ===== RESET ===== */
function resetTournament() {
  if (!confirm("Neues Turnier starten?")) return;
  localStorage.removeItem("americanoState");
  playerNames = [];
  stats = {};
  scoreInputs = {};
  plan.innerHTML = "";
  ranking.innerHTML = "";
  count.value = 8;
  renderPlayers();
}

/* ===== PLAYER INPUTS ===== */
function renderPlayers() {
  players.innerHTML = "";
  const c = parseInt(count.value);

  for (let i = 0; i < c; i++) {
    const val = playerNames[i] || "";
    playerNames[i] = val;

    players.innerHTML += `
      <input value="${val}"
        placeholder="Spieler ${i+1}"
        oninput="playerNames[${i}] = this.value; saveState();">
    `;
  }
  saveState();
}

count.onchange = renderPlayers;

/* ===================================================== */
/* =============== AMERICANO LOGIK ===================== */
/* ===================================================== */

function createPlan() {
  plan.innerHTML = "";
  stats = {};
  scoreInputs = {};

  const playersList = playerNames.filter(n => n.trim());
  const n = playersList.length;
  if (n < 4) return;

  playersList.forEach(p => stats[p] = { points: 0, games: 0 });

  /* ===== FALL 1: PERFEKT (n % 4 === 0) ===== */
  if (n % 4 === 0) {
    createPerfectAmericano(playersList);
    finalize();
    return;
  }

  /* ===== FALL 2: GENAU 1 PAUSE (n % 4 === 1) ===== */
  if (n % 4 === 1) {
    createSinglePauseAmericano(playersList);
    finalize();
    return;
  }

  /* ===== FALL 3: ANNÄHERUNG (n % 4 === 2 oder 3) ===== */
  createFairApproxAmericano(playersList);
  finalize();
}

/* ===== PERFEKTER AMERICANO ===== */
function createPerfectAmericano(players) {
  const rounds = players.length - 1;
  let rotation = [...players];

  for (let r = 0; r < rounds; r++) {
    const round = section(`Runde ${r + 1}`);

    for (let i = 0; i < rotation.length; i += 4) {
      renderMatch(round, r, i / 4,
        [rotation[i], rotation[i + 1]],
        [rotation[i + 2], rotation[i + 3]]
      );
    }

    plan.appendChild(round);

    const fixed = rotation[0];
    const rest = rotation.slice(1);
    rest.unshift(rest.pop());
    rotation = [fixed, ...rest];
  }
}

/* ===== 1 PAUSE PRO RUNDE ===== */
function createSinglePauseAmericano(players) {
  const n = players.length;
  const rounds = n;
  let rotation = [...players];

  for (let r = 0; r < rounds; r++) {
    const round = section(`Runde ${r + 1}`);

    const pause = rotation[0];
    const active = rotation.slice(1);

    for (let i = 0; i < active.length; i += 4) {
      renderMatch(round, r, i / 4,
        [active[i], active[i + 1]],
        [active[i + 2], active[i + 3]]
      );
    }

    pauseLine(round, [pause]);
    plan.appendChild(round);

    rotation.push(rotation.shift());
  }
}

/* ===== FAIRE ANNÄHERUNG ===== */
function createFairApproxAmericano(players) {
  const rounds = players.length;
  let rotation = [...players];

  for (let r = 0; r < rounds; r++) {
    const round = section(`Runde ${r + 1}`);

    const playable = Math.floor(rotation.length / 4) * 4;
    const active = rotation.slice(0, playable);
    const pause = rotation.slice(playable);

    // leichte Durchmischung erlaubt (Perfektion unmöglich)
    active.sort(() => Math.random() - 0.5);

    for (let i = 0; i < active.length; i += 4) {
      renderMatch(round, r, i / 4,
        [active[i], active[i + 1]],
        [active[i + 2], active[i + 3]]
      );
    }

    pauseLine(round, pause);
    plan.appendChild(round);

    rotation.push(rotation.shift());
  }
}

/* ===================================================== */
/* ================= RENDER HELPERS ==================== */
/* ===================================================== */

function section(title) {
  const s = document.createElement("div");
  s.className = "section";
  s.innerHTML = `<strong>${title}</strong>`;
  return s;
}

function renderMatch(round, r, m, A, B) {
  const idA = `r${r}-m${m}-A`;
  const idB = `r${r}-m${m}-B`;

  const div = document.createElement("div");
  div.className = "match";
  div.dataset.teamA = A.join("|");
  div.dataset.teamB = B.join("|");

  div.innerHTML = `
    <div class="team">${A.join(" & ")}</div>
    <input class="score" id="${idA}" type="number">
    <div>:</div>
    <input class="score" id="${idB}" type="number">
    <div class="team">${B.join(" & ")}</div>
  `;

  round.appendChild(div);
}

function pauseLine(round, list) {
  if (!list.length) return;
  const p = document.createElement("div");
  p.className = "pause";
  p.textContent = `Pause: ${list.join(", ")}`;
  round.appendChild(p);
}

function finalize() {
  document.querySelectorAll(".score").forEach(inp => {
    if (scoreInputs[inp.id] !== undefined) {
      inp.value = scoreInputs[inp.id];
    }
    inp.addEventListener("input", saveState);
  });
  saveState();
  updateRanking();
}

/* ===== CALC ===== */
function calculate() {
  Object.values(stats).forEach(s => { s.points = 0; s.games = 0; });

  document.querySelectorAll(".match").forEach(m => {
    const A = m.dataset.teamA.split("|");
    const B = m.dataset.teamB.split("|");
    const scores = m.querySelectorAll(".score");

    const a = parseInt(scores[0].value);
    const b = parseInt(scores[1].value);

    if (!isNaN(a)) A.forEach(p => { stats[p].points += a; stats[p].games++; });
    if (!isNaN(b)) B.forEach(p => { stats[p].points += b; stats[p].games++; });
  });

  saveState();
  updateRanking();
}

function updateRanking() {
  const rows = Object.entries(stats).map(([n,s]) => ({
    name:n,
    games:s.games,
    points:s.points,
    ppg:(s.games ? s.points/s.games : 0).toFixed(2)
  }));

  rows.sort((a,b)=>b.ppg-a.ppg || b.points-a.points);

  ranking.innerHTML = `
    <tr><th>Spieler</th><th>Spiele</th><th>Punkte</th><th>Punkte / Spiel</th></tr>
  `;

  rows.forEach(r => {
    ranking.innerHTML += `
      <tr>
        <td>${r.name}</td>
        <td>${r.games}</td>
        <td>${r.points}</td>
        <td>${r.ppg}</td>
      </tr>
    `;
  });
}

/* ===== INIT ===== */
loadState();
if (!count.value) count.value = 8;
renderPlayers();
</script>
